"use client";
import { useState, useEffect, useMemo, useCallback } from "react";
const SU="https://zkxwpkwlkbtzeocjvubc.supabase.co",SK="sb_publishable_Bamzthf5K8VwgHV9P0vx_A_C_OG9tmQ";
async function supa(p,o={}){const{method:m="GET",body:b,single:s,prefer:pr,headers:h2={}}=o;const t=window._sbToken||SK;const h={apikey:SK,Authorization:"Bearer "+t,"Content-Type":"application/json",...h2};if(s)h.Accept="application/vnd.pgrst.object+json";if(pr)h.Prefer=pr;const r=await fetch(SU+p,{method:m,headers:h,body:b?JSON.stringify(b):undefined});if(!r.ok){const e=await r.text().catch(()=>"Error");throw new Error(r.status+": "+e)}const x=await r.text();return x?JSON.parse(x):null}
async function signIn(e,p){const r=await fetch(SU+"/auth/v1/token?grant_type=password",{method:"POST",headers:{apikey:SK,"Content-Type":"application/json"},body:JSON.stringify({email:e,password:p})});if(!r.ok)throw new Error("Invalid email or password");return await r.json()}

const VARIANTS=[["Standard","NV"],["DocBlock","DB"],["RPF In-house","RV"],["RPF Labs","RL"],["Grower's Choice","GC"],["Preorder","PR"],["Bundle","BN"],["Specimen","SM"]];
const SIZES=[['2.5" Sq',"2S"],['3.25" Sq',"3S"],['3.5" Tall',"3T"],['4.5" Rd',"4R"],['5" Rd',"5R"],['6.5" Rd',"6R"],['10" Rd',"10"],["Plug","PG"],["Cutting","CT"],["Rehab","RH"],["Quarantine","QR"],["Mother","MO"]];
const SUPPLIERS=[["RPF Nursery","00"],["RPF Labs","01"],["RPF Secondary","02"],["DocBlock","10"],["Agri-Starts","11"],["Xai Leggett","12"],["Wuhoo Tropicals","13"],["Rare Plants TC","20"],["Casa Botanica","30"],["Casa Flora","31"],["Green Circle","50"],["Other","99"]];
const PRODS=[["Tissue culture","T"],["Seed","S"],["Stem cutting","C"],["Leaf cutting","L"],["Division","D"],["Imported","I"],["Import plug","P"]];
const STATUSES=["Growing","Quarantine","Rehab","Sellable","Staged for Live","Reserved","Sold","Shipped","Mother","Divided","T1-Initiation","T2-Multiplication","T3-Rooting","Hardening","Transfer Ready","Contaminated"];
const NURSERY_STATUSES=["Growing","Quarantine","Rehab","Sellable","Staged for Live","Reserved","Sold","Shipped","Mother","Divided"];
const LAB_STATUSES=["T1-Initiation","T2-Multiplication","T3-Rooting","Hardening","Transfer Ready","Contaminated"];
const ZONES=["Greenhouse A","Greenhouse B","Greenhouse C","Greenhouse D","Showroom","Quarantine Bay","Fulfillment Zone","Staging","Pickup Zone","TC Lab","TC Lab - Clean Room","TC Lab - Growth Chamber","Hardening Room","Terrarium Room"];
const CHANNELS=["Palmstreet","eBay Live","Whatnot","Website","Other"];

const STC={Growing:"#3D9A5F",Quarantine:"#C47A1A",Rehab:"#8B5CF6",Sellable:"#2D8A4E","Staged for Live":"#7C3AED",Reserved:"#2563EB",Sold:"#0891B2",Shipped:"#6B7280",Mother:"#9333EA",Divided:"#6B7280","T1-Initiation":"#2D6A4F","T2-Multiplication":"#40916C","T3-Rooting":"#52B788",Hardening:"#C47A1A","Transfer Ready":"#2563EB",Contaminated:"#DC2626"};
const K={c:"#0C0C0C",cb:"#1F1F1F",ct:"#EDEDED",cm:"#707070",cd:"#444"};
const W={bg:"#F8F7F4",card:"#FFF",hv:"#FAFAF8",b:"#E8E6E0",b2:"#D8D6D0",t:"#1A1A18",t2:"#6B6B66",t3:"#9A9A94",inp:"#F2F1ED"};
const PK={pk:"#F07B8D",ps:"#F4A0AE",pd:"rgba(240,123,141,.10)"};
const supN=c=>(SUPPLIERS.find(s=>s[1]===c)||["?"])[0];
const prodN=c=>(PRODS.find(s=>s[1]===c)||["?"])[0];
const loadFonts=()=>{if(document.getElementById("rpf-f"))return;const l=document.createElement("link");l.id="rpf-f";l.rel="stylesheet";l.href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700;9..40,800&family=JetBrains+Mono:wght@400;500;600&display=swap";document.head.appendChild(l)};
const Ic=({d,s:z=15,c="currentColor"})=><svg width={z} height={z} viewBox="0 0 24 24" fill="none" stroke={c} strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><path d={d}/></svg>;
const ico={leaf:"M17 8C8 10 5.9 16.09 3.82 21.18M12.35 5.65A8 8 0 0 1 20 12c0 4-3 8-8 8s-8-4-8-8a8 8 0 0 1 5.65-7.65",tag:"M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82zM7 7h.01",box:"M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z",clock:"M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20zM12 6v6l4 2",search:"M11 17.25a6.25 6.25 0 1 1 0-12.5 6.25 6.25 0 0 1 0 12.5zM16 16l4.5 4.5",plus:"M12 5v14M5 12h14",chk:"M20 6L9 17l-5-5",refresh:"M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15",out:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9",grid:"M3 3h7v7H3zM14 3h7v7h-7zM14 14h7v7h-7zM3 14h7v7H3z",back:"M19 12H5M12 19l-7-7 7-7",print:"M6 9V2h12v7M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2M6 14h12v8H6z",x:"M18 6L6 18M6 6l12 12",dl:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3",flask:"M9 3h6M10 3v6.5L4.5 20.5a1 1 0 0 0 .87 1.5h13.26a1 1 0 0 0 .87-1.5L14 9.5V3",radio:"M12 12m-2 0a2 2 0 1 0 4 0a2 2 0 1 0-4 0M4.93 19.07A10 10 0 0 1 2 12C2 6.48 6.48 2 12 2s10 4.48 10 10a10 10 0 0 1-2.93 7.07M7.76 16.24A6 6 0 0 1 6 12a6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-1.76 4.24",scan:"M2 8V6a2 2 0 0 1 2-2h4M2 16v2a2 2 0 0 0 2 2h4M16 4h2a2 2 0 0 1 2 2v2M16 20h2a2 2 0 0 0 2-2v-2M7 12h10"};
const Badge=({status})=>{const c=STC[status]||"#6B7280";return<span style={{display:"inline-flex",alignItems:"center",gap:4,padding:"3px 10px",borderRadius:20,fontSize:10,fontWeight:600,background:c+"12",color:c,letterSpacing:.2}}><span style={{width:5,height:5,borderRadius:"50%",background:c}}/>{status}</span>};
function makeQR(t){const s=21,m=Array.from({length:s},()=>Array(s).fill(false));const fp=(ox,oy)=>{for(let i=0;i<7;i++)for(let j=0;j<7;j++)m[oy+i][ox+j]=i===0||i===6||j===0||j===6||(i>=2&&i<=4&&j>=2&&j<=4)};fp(0,0);fp(s-7,0);fp(0,s-7);for(let i=7;i<s-7;i++){m[6][i]=i%2===0;m[i][6]=i%2===0}let h=0;for(let i=0;i<t.length;i++)h=((h<<5)-h+t.charCodeAt(i))|0;let seed=Math.abs(h);for(let y=0;y<s;y++)for(let x=0;x<s;x++){if(m[y][x])continue;if(y<7&&x<7)continue;if(y<7&&x>=s-7)continue;if(y>=s-7&&x<7)continue;seed=(seed*1103515245+12345)&0x7fffffff;m[y][x]=seed%3!==0}return m}
function QRCode({text,size=120}){const matrix=makeQR(text),n=matrix.length,cs=size/n;return<svg width={size} height={size} viewBox={`0 0 ${size} ${size}`} style={{display:"block"}}>{matrix.map((row,y)=>row.map((cell,x)=>cell?<rect key={`${y}-${x}`} x={x*cs} y={y*cs} width={cs+.5} height={cs+.5} fill="#1A1A18"/>:null))}</svg>}
const iL={width:"100%",padding:"7px 10px",border:`1px solid ${W.b}`,borderRadius:6,fontSize:11,fontFamily:"'DM Sans',system-ui,sans-serif",outline:"none",background:W.inp,color:W.t};
const iD={...iL,border:`1px solid ${K.cb}`,background:"#111",color:K.ct};
const bP={display:"inline-flex",alignItems:"center",gap:5,padding:"6px 14px",borderRadius:6,fontSize:11,fontWeight:600,cursor:"pointer",fontFamily:"inherit",background:PK.pk,color:"#0A0A0A",border:"none"};
const bO={display:"inline-flex",alignItems:"center",gap:5,padding:"6px 14px",borderRadius:6,fontSize:11,fontWeight:600,cursor:"pointer",fontFamily:"inherit",background:"transparent",border:`1px solid ${W.b}`,color:W.t2};
const bOD={...bO,border:`1px solid ${K.cb}`,color:K.cm};
const bGreen={...bP,background:"#2D8A4E",color:"#FFF"};
const bPurple={...bP,background:"#7C3AED",color:"#FFF"};
const pll=a=>({padding:"3px 9px",borderRadius:20,fontSize:10,fontWeight:600,cursor:"pointer",fontFamily:"inherit",whiteSpace:"nowrap",border:`1px solid ${a?PK.pk:W.b}`,background:a?"rgba(240,123,141,.08)":"transparent",color:a?PK.pk:W.t2});
const tdS={padding:"9px 14px",borderBottom:`1px solid ${W.b}`,verticalAlign:"middle"};
const skS={fontFamily:"'JetBrains Mono',monospace",fontSize:10.5,fontWeight:500,color:W.t,letterSpacing:.3};
const scS={background:W.card,border:`1px solid ${W.b}`,borderRadius:10,padding:14};
const shS={fontSize:9,fontWeight:700,textTransform:"uppercase",letterSpacing:1,color:W.t3,marginBottom:8};

/* ── CSV Export ── */
function exportCSV(rows,filename){if(!rows.length)return;const keys=Object.keys(rows[0]);const csv=[keys.join(","),...rows.map(r=>keys.map(k=>{let v=String(r[k]??"");if(v.includes(",")||v.includes('"')||v.includes("\n"))v='"'+v.replace(/"/g,'""')+'"';return v}).join(","))].join("\n");const blob=new Blob([csv],{type:"text/csv"});const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download=filename;a.click();URL.revokeObjectURL(url)}

/* ── Scan Modal ── */
function ScanModal({onClose,onResult}){const[query,setQuery]=useState("");const[scanning,setScanning]=useState(false);const doScan=()=>{setScanning(true);setTimeout(()=>{setScanning(false);if(query.trim())onResult(query.trim())},800)};return(<div style={{position:"fixed",inset:0,background:"rgba(0,0,0,.6)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:100}} onClick={onClose}><div style={{background:W.card,borderRadius:12,width:"92%",maxWidth:400,boxShadow:"0 20px 60px rgba(0,0,0,.3)"}} onClick={e=>e.stopPropagation()}><div style={{padding:"14px 18px",borderBottom:`1px solid ${W.b}`,display:"flex",justifyContent:"space-between",alignItems:"center"}}><span style={{fontSize:14,fontWeight:800}}>Scan / Lookup Plant</span><button style={bO} onClick={onClose}><Ic d={ico.x} s={12}/></button></div><div style={{padding:18}}><div style={{display:"flex",alignItems:"center",justifyContent:"center",padding:20,border:`2px dashed ${W.b}`,borderRadius:10,marginBottom:14,background:scanning?"rgba(240,123,141,.05)":W.inp}}><div style={{textAlign:"center"}}><Ic d={ico.scan} s={48} c={scanning?PK.pk:W.t3}/><div style={{fontSize:11,color:scanning?PK.pk:W.t3,marginTop:6,fontWeight:600}}>{scanning?"Scanning…":"Point camera at QR code"}</div><div style={{fontSize:10,color:W.t3,marginTop:2}}>or type SKU / name below</div></div></div><div style={{display:"flex",gap:6}}><input style={{...iL,flex:1,fontSize:13,fontFamily:"'JetBrains Mono',monospace"}} value={query} onChange={e=>setQuery(e.target.value)} placeholder="SKU, PLANT code, or name…" onKeyDown={e=>e.key==="Enter"&&doScan()} autoFocus/><button style={bP} onClick={doScan}><Ic d={ico.search} s={13}/> Look Up</button></div></div></div></div>)}

/* ── Login ── */
function Login({onLogin}){const[email,setEmail]=useState("");const[pw,setPw]=useState("");const[err,setErr]=useState("");const[ld,setLd]=useState(false);const go=async()=>{setErr("");setLd(true);try{onLogin(await signIn(email,pw))}catch(e){setErr(e.message)}setLd(false)};return(<div style={{display:"flex",alignItems:"center",justifyContent:"center",height:"100vh",background:"#000",fontFamily:"'DM Sans',system-ui,sans-serif"}}><div style={{width:380,textAlign:"center"}}><img src="/logo-login.png" alt="Rare Plant Fairy" style={{width:160,marginBottom:12}}/><div style={{fontSize:11,color:"#555",marginBottom:32,letterSpacing:1,textTransform:"uppercase",fontWeight:600}}>Inventory System</div>{err&&<div style={{background:"rgba(240,123,141,.12)",color:PK.pk,padding:"8px 14px",borderRadius:6,fontSize:11,fontWeight:600,marginBottom:14}}>{err}</div>}<div style={{marginBottom:12,textAlign:"left"}}><label style={{display:"block",fontSize:10,fontWeight:600,color:"#666",marginBottom:3}}>Email</label><input style={{...iD,padding:"10px 12px",fontSize:12,borderRadius:8}} type="email" value={email} onChange={e=>setEmail(e.target.value)} placeholder="you@rareplantfairy.com" onKeyDown={e=>e.key==="Enter"&&go()}/></div><div style={{marginBottom:20,textAlign:"left"}}><label style={{display:"block",fontSize:10,fontWeight:600,color:"#666",marginBottom:3}}>Password</label><input style={{...iD,padding:"10px 12px",fontSize:12,borderRadius:8}} type="password" value={pw} onChange={e=>setPw(e.target.value)} placeholder="••••••••" onKeyDown={e=>e.key==="Enter"&&go()}/></div><button onClick={go} disabled={ld} style={{...bP,width:"100%",justifyContent:"center",padding:"11px 16px",fontSize:13,borderRadius:8,fontWeight:700,opacity:ld?.6:1}}>{ld?"Signing in…":"Sign In"}</button><div style={{marginTop:20,fontSize:10,color:"#444"}}>Admin creates accounts in Supabase → Authentication → Users</div></div></div>)}

/* ── Sidebar ── */
function Sidebar({navs,dash,setDash,email,onLogout}){return(<div style={{width:200,background:K.c,display:"flex",flexDirection:"column",borderRight:`1px solid ${K.cb}`,flexShrink:0}}><div style={{padding:"20px 16px 16px",borderBottom:`1px solid ${K.cb}`}}><div style={{fontSize:16,fontWeight:800,color:PK.pk,letterSpacing:-.3}}>Rare Plant Fairy</div><div style={{fontSize:9,color:K.cd,marginTop:3,letterSpacing:1.5,textTransform:"uppercase",fontWeight:600}}>Inventory v8.1</div></div><div style={{flex:1,padding:"6px 6px",overflowY:"auto"}}>{navs.map((n,i)=>n.sec?<div key={i} style={{fontSize:9,fontWeight:700,textTransform:"uppercase",letterSpacing:1.5,color:K.cd,padding:"18px 10px 6px"}}>{n.sec}</div>:<button key={n.k} onClick={()=>setDash(n.k)} style={{display:"flex",alignItems:"center",gap:8,padding:"8px 10px",borderRadius:6,cursor:"pointer",fontSize:12,fontWeight:dash===n.k?600:400,color:dash===n.k?PK.pk:K.cm,background:dash===n.k?"rgba(240,123,141,.08)":"transparent",border:"none",width:"100%",textAlign:"left",fontFamily:"inherit",transition:"all .15s"}}><Ic d={n.ic} s={14} c={dash===n.k?PK.pk:K.cd}/><span>{n.l}</span>{n.bg!=null?<span style={{marginLeft:"auto",fontSize:10,fontWeight:600,color:dash===n.k?PK.pk:K.cd,background:dash===n.k?"rgba(240,123,141,.12)":"rgba(255,255,255,.04)",padding:"1px 7px",borderRadius:10}}>{n.bg}</span>:null}</button>)}</div><div style={{padding:"12px 14px",borderTop:`1px solid ${K.cb}`}}><div style={{fontSize:10,color:K.cd}}>{email}</div><button onClick={onLogout} style={{display:"flex",alignItems:"center",gap:6,marginTop:6,fontSize:11,color:K.cd,background:"none",border:"none",cursor:"pointer",fontFamily:"inherit",padding:0}}><Ic d={ico.out} s={12} c={K.cd}/> Sign Out</button></div></div>)}

/* ── TopBar ── */
function TopBar({label,entity,sq,setSq,onRefresh,onNew,onScan,onExport}){return(<div style={{height:52,background:K.c,borderBottom:`1px solid ${K.cb}`,display:"flex",alignItems:"center",padding:"0 20px",gap:10,flexShrink:0}}><span style={{fontSize:15,fontWeight:800,letterSpacing:-.3,color:K.ct}}>{label}</span><span style={{fontSize:10,fontWeight:600,padding:"3px 10px",borderRadius:20,background:entity==="Lab"?"rgba(82,183,136,.12)":PK.pd,color:entity==="Lab"?"#52B788":PK.pk}}>{entity==="Lab"?"RPF Labs":"RPF Nursery"}</span><div style={{flex:1,maxWidth:300,position:"relative"}}><div style={{position:"absolute",left:10,top:"50%",transform:"translateY(-50%)",color:K.cd}}><Ic d={ico.search} s={13}/></div><input style={{...iD,paddingLeft:32}} placeholder="Search SKU, name, zone…" value={sq} onChange={e=>setSq(e.target.value)}/></div>{onScan&&<button style={{...bOD,background:"rgba(124,58,237,.15)",borderColor:"#7C3AED",color:"#A78BFA"}} onClick={onScan}><Ic d={ico.scan} s={13} c="#A78BFA"/> Scan</button>}{onExport&&<button style={bOD} onClick={onExport}><Ic d={ico.dl} s={13}/> Export CSV</button>}<button style={bOD} onClick={onRefresh}><Ic d={ico.refresh} s={13}/></button>{onNew&&<button style={bP} onClick={onNew}><Ic d={ico.plus} s={13}/> New Plant</button>}</div>)}

/* ── Data Table ── */
function FTable({items,cols,onRow,stF,setStF,znF,setZnF,sq}){const[sCol,setSCol]=useState(null);const[sDir,setSDir]=useState("asc");const data=useMemo(()=>{let f=items;if(sq){const q=sq.toLowerCase();f=f.filter(i=>i.sku?.toLowerCase().includes(q)||i.name?.toLowerCase().includes(q)||(i.zone||"").toLowerCase().includes(q)||(i.plant_code||"").toLowerCase().includes(q))}if(stF)f=f.filter(i=>i.status===stF);if(znF)f=f.filter(i=>i.zone===znF);if(sCol)f=[...f].sort((a,b)=>{let va=a[sCol],vb=b[sCol];if(typeof va==="number"&&typeof vb==="number")return sDir==="asc"?va-vb:vb-va;return sDir==="asc"?String(va||"").localeCompare(String(vb||"")):String(vb||"").localeCompare(String(va||""))});return f},[items,sq,stF,znF,sCol,sDir]);const stCounts=useMemo(()=>{const c={};items.forEach(i=>{c[i.status]=(c[i.status]||0)+1});return c},[items]);const zones=useMemo(()=>[...new Set(items.map(i=>i.zone).filter(Boolean))].sort(),[items]);return(<div style={{background:W.card,borderRadius:10,border:`1px solid ${W.b}`,overflow:"hidden",boxShadow:"0 1px 3px rgba(0,0,0,.04)"}}><div style={{padding:"10px 14px",borderBottom:`1px solid ${W.b}`,display:"flex",flexDirection:"column",gap:6}}><div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}><span style={{fontSize:12,fontWeight:700,color:W.t2}}>{data.length} records</span><select style={{...iL,width:"auto",padding:"3px 8px",fontSize:10}} value={znF} onChange={e=>setZnF(e.target.value)}><option value="">All Zones</option>{zones.map(z=><option key={z} value={z}>{z}</option>)}</select></div><div style={{display:"flex",gap:4,flexWrap:"wrap"}}><button onClick={()=>setStF("")} style={pll(!stF)}>All <b style={{marginLeft:2}}>{items.length}</b></button>{Object.entries(stCounts).sort((a,b)=>b[1]-a[1]).map(([s,ct])=>(<button key={s} onClick={()=>setStF(stF===s?"":s)} style={pll(stF===s)}><span style={{width:5,height:5,borderRadius:3,background:STC[s]||"#999",display:"inline-block",marginRight:3}}/>{s} <b style={{marginLeft:2}}>{ct}</b></button>))}</div></div><div style={{overflowX:"auto"}}><table style={{width:"100%",borderCollapse:"collapse",fontSize:12}}><thead><tr>{cols.map(c=><th key={c.k} style={{textAlign:"left",padding:"8px 14px",fontSize:9,fontWeight:700,textTransform:"uppercase",letterSpacing:1,color:W.t3,borderBottom:`1px solid ${W.b}`,background:W.inp,cursor:"pointer"}} onClick={()=>{if(sCol===c.k)setSDir(d=>d==="asc"?"desc":"asc");else{setSCol(c.k);setSDir("asc")}}}>{c.l}{sCol===c.k?(sDir==="asc"?" ↑":" ↓"):""}</th>)}</tr></thead><tbody>{data.map(it=><tr key={it.id} onClick={()=>onRow(it)} style={{cursor:"pointer",transition:"background .1s"}} onMouseEnter={e=>e.currentTarget.style.background=W.hv} onMouseLeave={e=>e.currentTarget.style.background="transparent"}>{cols.map(c=><td key={c.k} style={tdS}>{c.r?c.r(it):it[c.k]}</td>)}</tr>)}{data.length===0&&<tr><td colSpan={cols.length} style={{...tdS,textAlign:"center",padding:30,color:W.t3}}>No items match.</td></tr>}</tbody></table></div></div>)}

/* ── Detail View ── */
function Detail({item,onBack,onStatusChange}){const[ns,setNs]=useState("");const[saving,setSaving]=useState(false);const isLab=LAB_STATUSES.includes(item.status);const statusList=isLab?LAB_STATUSES:NURSERY_STATUSES;const doSave=async()=>{setSaving(true);try{await onStatusChange(item.id,item.sku,item.status,ns);setNs("")}catch(e){alert("Error: "+e.message)}setSaving(false)};return(<div><div style={{display:"flex",alignItems:"center",gap:8,marginBottom:16}}><button onClick={onBack} style={{...bO,gap:4}}><Ic d={ico.back} s={13}/> Back</button><span style={{fontSize:18,fontWeight:800,letterSpacing:-.3}}>{item.name}</span><Badge status={item.status}/></div><div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:16}}><div><div style={scS}><div style={shS}>Identification</div>{[["SKU",<span key="s" style={skS}>{item.sku}</span>],["PLANT",item.plant_code],["Variant",(VARIANTS.find(v=>v[1]===item.variant)||[])[0]||item.variant],["Size",item.size],["Source",supN(item.source)],["Production",prodN(item.production)],["Batch",item.batch]].map(([k,v],i)=><div key={i} style={{display:"flex",justifyContent:"space-between",padding:"4px 0",fontSize:12}}><span style={{color:W.t3}}>{k}</span><span style={{fontWeight:600}}>{v}</span></div>)}</div><div style={{...scS,marginTop:10}}><div style={shS}>Location</div>{[["Zone",item.zone],["Station",item.station||"—"],["Qty",<span key="q" style={{fontWeight:800,fontSize:16,color:PK.pk}}>{item.qty}</span>],["Created",item.created_at?new Date(item.created_at).toLocaleDateString():"—"]].map(([k,v],i)=><div key={i} style={{display:"flex",justifyContent:"space-between",padding:"4px 0",fontSize:12}}><span style={{color:W.t3}}>{k}</span><span style={{fontWeight:600}}>{v}</span></div>)}{item.notes&&<div style={{display:"flex",justifyContent:"space-between",padding:"4px 0",fontSize:12}}><span style={{color:W.t3}}>Notes</span><span style={{maxWidth:180,textAlign:"right"}}>{item.notes}</span></div>}</div></div><div><div style={{display:"flex",flexDirection:"column",alignItems:"center",gap:8,background:W.card,border:`2px dashed ${W.b}`,borderRadius:10,padding:20}}><QRCode text={`app.rareplantfairy.com/inv/${item.sku}`} size={140}/><div style={{...skS,fontSize:11,color:W.t3}}>{item.sku}</div><button style={bO}><Ic d={ico.print} s={12}/> Print Label</button></div><div style={{...scS,marginTop:10}}><div style={shS}>Update Status</div><div style={{display:"flex",gap:5}}><select style={{...iL,flex:1}} value={ns} onChange={e=>setNs(e.target.value)}><option value="">Select…</option>{statusList.filter(s=>s!==item.status).map(s=><option key={s} value={s}>{s}</option>)}</select><button style={{...bP,opacity:(!ns||saving)?.4:1}} disabled={!ns||saving} onClick={doSave}>{saving?"…":"Save"}</button></div></div></div></div></div>)}

/* ── Live Sales Dashboard ── */
function LiveSalesDash({inv,showToast,loadData}){
  const[sessions,setSessions]=useState([]);const[activeSess,setActiveSess]=useState(null);const[items,setItems]=useState([]);const[creating,setCreating]=useState(false);const[newName,setNewName]=useState("");const[newChannel,setNewChannel]=useState("Palmstreet");const[showPicker,setShowPicker]=useState(false);const[scanning,setScanning]=useState(false);
  const today=new Date();const mmdd=String(today.getMonth()+1).padStart(2,"0")+String(today.getDate()).padStart(2,"0");

  const loadSessions=useCallback(async()=>{try{const s=await supa("/rest/v1/live_sessions?select=*&order=created_at.desc&limit=20");setSessions(s||[])}catch(e){console.error(e)}},[]);
  const loadItems=useCallback(async(sid)=>{try{const i=await supa(`/rest/v1/live_session_items?session_id=eq.${sid}&select=*&order=live_number.asc`);setItems(i||[])}catch(e){console.error(e)}},[]);
  useEffect(()=>{loadSessions()},[loadSessions]);
  useEffect(()=>{if(activeSess)loadItems(activeSess.id)},[activeSess,loadItems]);

  const createSession=async()=>{if(!newName.trim())return;try{const s=await supa("/rest/v1/live_sessions?select=*",{method:"POST",body:{name:newName.trim(),channel:newChannel,mmdd,status:"Prep",next_seq:1},prefer:"return=representation",single:true});setSessions(p=>[s,...p]);setActiveSess(s);setItems([]);setCreating(false);setNewName("");showToast("Session created: "+s.name)}catch(e){showToast("Error: "+e.message)}};

  const addPlant=async(plant)=>{if(!activeSess)return;const seq=String(activeSess.next_seq).padStart(3,"0");const liveNum=`${activeSess.mmdd}-${seq}`;try{const item=await supa("/rest/v1/live_session_items?select=*",{method:"POST",body:{session_id:activeSess.id,inventory_id:plant.id,live_number:liveNum,plant_name:plant.name,sku:plant.sku,price:0,qty:plant.qty||1},prefer:"return=representation",single:true});await supa(`/rest/v1/inventory?id=eq.${plant.id}`,{method:"PATCH",body:{status:"Staged for Live"},prefer:"return=minimal"});await supa("/rest/v1/activity_log",{method:"POST",body:{inventory_id:plant.id,sku:plant.sku,action:"staged_for_live",old_value:plant.status,new_value:"Staged for Live",detail:`Added to ${activeSess.name} as ${liveNum}`},prefer:"return=minimal"});await supa(`/rest/v1/live_sessions?id=eq.${activeSess.id}`,{method:"PATCH",body:{next_seq:activeSess.next_seq+1},prefer:"return=minimal"});setActiveSess(p=>({...p,next_seq:p.next_seq+1}));setItems(p=>[...p,item]);setShowPicker(false);loadData();showToast(`${liveNum} → ${plant.name}`)}catch(e){showToast("Error: "+e.message)}};

  const toggleSold=async(item)=>{const ns=!item.sold;try{await supa(`/rest/v1/live_session_items?id=eq.${item.id}`,{method:"PATCH",body:{sold:ns},prefer:"return=minimal"});setItems(p=>p.map(i=>i.id===item.id?{...i,sold:ns}:i));if(item.inventory_id){await supa(`/rest/v1/inventory?id=eq.${item.inventory_id}`,{method:"PATCH",body:{status:ns?"Sold":"Staged for Live"},prefer:"return=minimal"})}}catch(e){showToast("Error: "+e.message)}};

  const updatePrice=async(item,price)=>{try{await supa(`/rest/v1/live_session_items?id=eq.${item.id}`,{method:"PATCH",body:{price:parseFloat(price)||0},prefer:"return=minimal"});setItems(p=>p.map(i=>i.id===item.id?{...i,price}:i))}catch(e){showToast("Error: "+e.message)}};

  const doExport=()=>{if(!items.length)return;exportCSV(items.map(i=>({SKU:i.live_number,Name:i.plant_name,Price:i.price||0,Quantity:i.qty||1})),`${activeSess?.name||"live"}_${mmdd}.csv`);showToast(`Exported ${items.length} items`)};

  const handleScan=(q)=>{setScanning(false);const match=inv.find(i=>i.sku?.toLowerCase()===q.toLowerCase()||i.plant_code?.toLowerCase()===q.toLowerCase()||i.name?.toLowerCase().includes(q.toLowerCase()));if(match){if(match.status==="Sellable"||match.status==="Growing")addPlant(match);else showToast(`${match.name} is "${match.status}" — can't stage`)}else showToast("No plant found: "+q)};

  const sellable=inv.filter(i=>i.status==="Sellable"&&!items.find(it=>it.inventory_id===i.id));
  const soldCount=items.filter(i=>i.sold).length;
  const totalRev=items.filter(i=>i.sold).reduce((s,i)=>s+(parseFloat(i.price)||0),0);

  if(!activeSess)return(<div>
    <div style={{display:"flex",gap:10,marginBottom:16}}>{!creating?<button style={bP} onClick={()=>setCreating(true)}><Ic d={ico.plus} s={13}/> New Live Session</button>:<div style={{...scS,display:"flex",gap:8,alignItems:"flex-end",flex:1}}><div style={{flex:1}}><label style={{display:"block",fontSize:10,fontWeight:600,color:W.t2,marginBottom:2}}>Session Name</label><input style={iL} value={newName} onChange={e=>setNewName(e.target.value)} placeholder={`Palmstreet Evening ${mmdd}`} autoFocus onKeyDown={e=>e.key==="Enter"&&createSession()}/></div><div><label style={{display:"block",fontSize:10,fontWeight:600,color:W.t2,marginBottom:2}}>Channel</label><select style={iL} value={newChannel} onChange={e=>setNewChannel(e.target.value)}>{CHANNELS.map(c=><option key={c} value={c}>{c}</option>)}</select></div><button style={bP} onClick={createSession}>Create</button><button style={bO} onClick={()=>setCreating(false)}>Cancel</button></div>}</div>
    {sessions.length===0?<div style={{...scS,textAlign:"center",padding:40,color:W.t3}}>No live sessions yet. Create one to get started.</div>:sessions.map(s=><div key={s.id} onClick={()=>setActiveSess(s)} style={{...scS,marginBottom:8,cursor:"pointer",display:"flex",justifyContent:"space-between",alignItems:"center"}}><div><div style={{fontSize:14,fontWeight:700}}>{s.name}</div><div style={{fontSize:11,color:W.t3,marginTop:2}}>{s.channel} · {s.session_date} · {s.mmdd}</div></div><span style={{fontSize:10,fontWeight:600,padding:"3px 10px",borderRadius:20,background:"rgba(124,58,237,.08)",color:"#7C3AED"}}>{s.status}</span></div>)}
  </div>);

  return(<div>
    <div style={{display:"flex",gap:8,marginBottom:12,alignItems:"center"}}><button style={{...bO,gap:4}} onClick={()=>{setActiveSess(null);setItems([])}}><Ic d={ico.back} s={13}/> Sessions</button><span style={{fontSize:16,fontWeight:800}}>{activeSess.name}</span><span style={{fontSize:10,fontWeight:600,padding:"3px 10px",borderRadius:20,background:"rgba(124,58,237,.1)",color:"#7C3AED"}}>{activeSess.channel}</span></div>
    <div style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:10,marginBottom:14}}>{[["Items",items.length,W.t],["Sold",soldCount,STC.Sellable],["Unsold",items.length-soldCount,W.t3],["Revenue","$"+totalRev.toFixed(0),PK.pk]].map(([l,v,c])=><div key={l} style={{...scS,textAlign:"center"}}><div style={{fontSize:9,fontWeight:700,textTransform:"uppercase",letterSpacing:.8,color:W.t3}}>{l}</div><div style={{fontSize:22,fontWeight:800,color:c,fontFamily:"'JetBrains Mono',monospace"}}>{v}</div></div>)}</div>
    <div style={{display:"flex",gap:6,marginBottom:14}}><button style={bPurple} onClick={()=>setScanning(true)}><Ic d={ico.scan} s={13} c="#FFF"/> Scan Plant</button><button style={bO} onClick={()=>setShowPicker(true)}><Ic d={ico.plus} s={13}/> Add Manually</button><button style={bGreen} onClick={doExport}><Ic d={ico.dl} s={13} c="#FFF"/> Export CSV → {activeSess.channel}</button></div>
    {showPicker&&<div style={{...scS,marginBottom:12,maxHeight:250,overflowY:"auto"}}><div style={{display:"flex",justifyContent:"space-between",marginBottom:8}}><span style={shS}>Sellable Plants</span><button style={bO} onClick={()=>setShowPicker(false)}><Ic d={ico.x} s={11}/></button></div>{sellable.length===0?<div style={{color:W.t3,fontSize:11,padding:10}}>No sellable plants available.</div>:sellable.map(p=><div key={p.id} onClick={()=>addPlant(p)} style={{display:"flex",justifyContent:"space-between",padding:"6px 8px",borderRadius:6,cursor:"pointer",fontSize:12,borderBottom:`1px solid ${W.inp}`}} onMouseEnter={e=>e.currentTarget.style.background=W.hv} onMouseLeave={e=>e.currentTarget.style.background="transparent"}><span><span style={skS}>{p.sku}</span> {p.name}</span><span style={{color:W.t3}}>×{p.qty}</span></div>)}</div>}
    <div style={scS}><div style={shS}>Session Items — Tap number to mark sold</div>{items.length===0?<div style={{color:W.t3,fontSize:11,textAlign:"center",padding:20}}>Scan plants or add manually to build your live session</div>:items.map(item=><div key={item.id} style={{display:"flex",alignItems:"center",gap:10,padding:"8px 10px",marginBottom:4,borderRadius:8,background:item.sold?"rgba(45,138,78,.06)":"transparent",border:`1px solid ${item.sold?STC.Sellable:W.b}`,transition:"all .15s"}}><div onClick={()=>toggleSold(item)} style={{width:40,height:40,borderRadius:8,background:item.sold?STC.Sellable:K.c,color:"#FFF",display:"flex",alignItems:"center",justifyContent:"center",fontFamily:"'JetBrains Mono',monospace",fontSize:12,fontWeight:700,flexShrink:0,cursor:"pointer"}}>{item.sold?<Ic d={ico.chk} s={16} c="#FFF"/>:item.live_number.split("-")[1]}</div><div style={{flex:1,minWidth:0}}><div style={{fontSize:12,fontWeight:600,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>{item.plant_name}</div><div style={{fontSize:10,color:W.t3,fontFamily:"'JetBrains Mono',monospace"}}>{item.live_number} · {item.sku||"—"}</div></div><input style={{...iL,width:70,textAlign:"right",fontFamily:"'JetBrains Mono',monospace",fontWeight:700,fontSize:13}} value={item.price||""} onChange={e=>updatePrice(item,e.target.value)} placeholder="$0" onClick={e=>e.stopPropagation()}/></div>)}</div>
    {items.length>0&&<div style={{marginTop:12,background:W.inp,borderRadius:8,padding:12}}><div style={{fontSize:10,fontWeight:700,color:W.t2,marginBottom:4}}>CSV Preview → {activeSess.channel}</div><div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:10,color:W.t3,lineHeight:1.6}}><div style={{fontWeight:700,color:W.t}}>SKU, Name, Price, Quantity</div>{items.slice(0,3).map((i,idx)=><div key={idx}>{i.live_number}, {i.plant_name}, {i.price||0}, {i.qty||1}</div>)}{items.length>3&&<div>… +{items.length-3} more rows</div>}</div></div>}
    {scanning&&<ScanModal onClose={()=>setScanning(false)} onResult={handleScan}/>}
  </div>);
}

/* ── SKU Modal ── */
function Fl({label,children}){return <div style={{marginBottom:10}}><label style={{display:"block",fontSize:10,fontWeight:600,color:W.t2,marginBottom:2}}>{label}</label>{children}</div>}
function SKUModal({plants,onClose,onAdd,isLab}){const[f,sF]=useState({plant_code:"",vr:"NV",sz:"",src:isLab?"01":"00",p:isLab?"T":"C",bt:"01",name:"",qty:1,zone:isLab?"TC Lab":"",station:"",notes:"",customCode:false,status:isLab?"T1-Initiation":"Growing"});const[saving,setSaving]=useState(false);const[err,setErr]=useState("");const u=(k,v)=>sF(p=>({...p,[k]:v}));const sku=f.plant_code.length===5&&f.vr&&f.sz&&f.src&&f.p&&f.bt?`${f.plant_code}${f.vr}${f.sz}${f.src}${f.p}${f.bt.padStart(2,"0")}`:"";const pick=code=>{if(code==="__custom"){u("customCode",true);u("plant_code","");return}const pl=plants.find(p=>p.plant_code===code);u("plant_code",code);u("customCode",false);if(pl)u("name",pl.marketing_name)};const doCreate=async()=>{setSaving(true);setErr("");try{const isNew=!plants.find(p=>p.plant_code===f.plant_code);if(isNew&&f.plant_code.length===5){await supa("/rest/v1/plant_registry",{method:"POST",body:{plant_code:f.plant_code,marketing_name:f.name,genus:f.name.split(" ")[0]||"Unknown",species:f.name},prefer:"return=minimal"})}await onAdd({sku,plant_code:f.plant_code,name:f.name,variant:f.vr,size:f.sz,source:f.src,production:f.p,batch:f.bt.padStart(2,"0"),status:f.status,qty:parseInt(f.qty)||1,zone:f.zone,station:f.station||null,notes:f.notes||null});onClose()}catch(e){setErr(e.message)}setSaving(false)};return(<div style={{position:"fixed",inset:0,background:"rgba(0,0,0,.5)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:100}} onClick={onClose}><div style={{background:W.card,borderRadius:12,width:"92%",maxWidth:520,maxHeight:"85vh",overflowY:"auto",boxShadow:"0 20px 60px rgba(0,0,0,.2)"}} onClick={e=>e.stopPropagation()}><div style={{padding:"14px 18px",borderBottom:`1px solid ${W.b}`,display:"flex",justifyContent:"space-between",alignItems:"center"}}><span style={{fontSize:14,fontWeight:800}}>{isLab?"New TC Culture":"New Plant"}</span><button style={bO} onClick={onClose}><Ic d={ico.x} s={12}/></button></div><div style={{padding:18}}><div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:16,fontWeight:700,color:W.t,background:W.inp,padding:"9px 12px",borderRadius:6,textAlign:"center",letterSpacing:1,marginBottom:12,border:`1px solid ${W.b}`}}>{sku||"Fill fields…"}</div>{err&&<div style={{background:"rgba(240,123,141,.08)",color:PK.pk,padding:"8px 12px",borderRadius:6,fontSize:11,fontWeight:600,marginBottom:12}}>{err}</div>}<Fl label="Species / Name"><input style={iL} value={f.name} onChange={e=>u("name",e.target.value)} placeholder="A. crystallinum"/></Fl><div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}><Fl label="PLANT Code"><select style={{...iL,marginBottom:f.customCode?6:0}} value={f.customCode?"__custom":f.plant_code} onChange={e=>pick(e.target.value)}><option value="">Select species…</option>{plants.map(p=><option key={p.plant_code} value={p.plant_code}>{p.plant_code} — {p.marketing_name}</option>)}<option value="__custom">+ New species…</option></select>{f.customCode&&<input style={{...iL,fontFamily:"'JetBrains Mono',monospace",marginTop:4}} value={f.plant_code} onChange={e=>u("plant_code",e.target.value.toUpperCase())} maxLength={5} placeholder="5-char code"/>}</Fl><Fl label="Variant"><select style={iL} value={f.vr} onChange={e=>u("vr",e.target.value)}>{VARIANTS.map(v=><option key={v[1]} value={v[1]}>{v[1]} — {v[0]}</option>)}</select></Fl></div><div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}><Fl label="Size"><select style={iL} value={f.sz} onChange={e=>u("sz",e.target.value)}><option value="">Select…</option>{SIZES.map(s=><option key={s[1]} value={s[1]}>{s[1]} — {s[0]}</option>)}</select></Fl><Fl label="Source"><select style={iL} value={f.src} onChange={e=>u("src",e.target.value)}>{SUPPLIERS.map(s=><option key={s[1]} value={s[1]}>{s[1]} — {s[0]}</option>)}</select></Fl></div><div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}><Fl label="Production"><select style={iL} value={f.p} onChange={e=>u("p",e.target.value)}>{PRODS.map(p=><option key={p[1]} value={p[1]}>{p[1]} — {p[0]}</option>)}</select></Fl><Fl label="Batch #"><input style={{...iL,fontFamily:"'JetBrains Mono',monospace"}} value={f.bt} onChange={e=>u("bt",e.target.value)} maxLength={2}/></Fl></div>{isLab&&<Fl label="Initial Status"><select style={iL} value={f.status} onChange={e=>u("status",e.target.value)}>{LAB_STATUSES.map(s=><option key={s} value={s}>{s}</option>)}</select></Fl>}<div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:8}}><Fl label="Qty"><input style={iL} type="number" min="1" value={f.qty} onChange={e=>u("qty",e.target.value)}/></Fl><Fl label="Zone"><select style={iL} value={f.zone} onChange={e=>u("zone",e.target.value)}><option value="">Select…</option>{ZONES.map(z=><option key={z} value={z}>{z}</option>)}</select></Fl><Fl label="Station"><input style={iL} value={f.station} onChange={e=>u("station",e.target.value)} placeholder="Bench 2"/></Fl></div><Fl label="Notes (optional)"><input style={iL} value={f.notes} onChange={e=>u("notes",e.target.value)} placeholder={isLab?"Medium, passage info…":"Import notes…"}/></Fl></div><div style={{padding:"12px 18px",borderTop:`1px solid ${W.b}`,display:"flex",justifyContent:"flex-end",gap:6}}><button style={bO} onClick={onClose}>Cancel</button><button style={{...bP,opacity:(!sku||!f.name||!f.zone||saving)?.4:1}} disabled={!sku||!f.name||!f.zone||saving} onClick={doCreate}><Ic d={ico.plus} s={12}/> {saving?"Creating…":"Create"}</button></div></div></div>)}

/* ── Main App ── */
export default function App(){
  useEffect(()=>{loadFonts()},[]);
  const[auth,setAuth]=useState(null);const[inv,setInv]=useState([]);const[logData,setLogData]=useState([]);const[plants,setPlants]=useState([]);const[loading,setLoading]=useState(false);const[dash,setDash]=useState("grow");const[sel,setSel]=useState(null);const[modal,setModal]=useState(false);const[sq,setSq]=useState("");const[stF,setStF]=useState("");const[znF,setZnF]=useState("");const[toast,setToast]=useState("");const[scanOpen,setScanOpen]=useState(false);
  const showToast=m=>{setToast(m);setTimeout(()=>setToast(""),3000)};
  const handleLogin=d=>{setAuth(d);window._sbToken=d.access_token};
  const handleLogout=()=>{setAuth(null);window._sbToken=null};

  const loadData=useCallback(async()=>{if(!auth)return;setLoading(true);try{const[i,l,p]=await Promise.all([supa("/rest/v1/inventory?select=*&order=name.asc"),supa("/rest/v1/activity_log?select=*&order=created_at.desc&limit=50"),supa("/rest/v1/plant_registry?select=*&order=marketing_name.asc")]);setInv(i||[]);setLogData(l||[]);setPlants(p||[])}catch(e){showToast("Error: "+e.message)}setLoading(false)},[auth]);
  useEffect(()=>{if(auth)loadData()},[auth,loadData]);

  const onStatusChange=async(id,sku,old,nw)=>{await supa(`/rest/v1/inventory?id=eq.${id}`,{method:"PATCH",body:{status:nw},prefer:"return=representation"});await supa("/rest/v1/activity_log",{method:"POST",body:{inventory_id:id,sku,action:"status_change",old_value:old,new_value:nw,detail:`${old} → ${nw}`},prefer:"return=minimal"});showToast(`${sku} → ${nw}`);await loadData();if(sel&&sel.id===id)setSel(p=>({...p,status:nw}))};

  const onAdd=async r=>{await supa("/rest/v1/inventory",{method:"POST",body:r,prefer:"return=minimal"});await supa("/rest/v1/activity_log",{method:"POST",body:{sku:r.sku,action:"created",new_value:r.status,detail:`${r.name} · Qty: ${r.qty} · ${r.zone}`},prefer:"return=minimal"});showToast(`Created ${r.sku}`);await loadData()};

  const handleScanResult=(q)=>{setScanOpen(false);const match=inv.find(i=>i.sku?.toLowerCase()===q.toLowerCase()||i.plant_code?.toLowerCase()===q.toLowerCase()||i.name?.toLowerCase().includes(q.toLowerCase()));if(match){setSel(match);showToast(`Found: ${match.name}`)}else showToast("No plant found: "+q)};

  const doExportTab=()=>{const isLab=dash==="lab";const items=isLab?inv.filter(i=>LAB_STATUSES.includes(i.status)):dash==="grow"?inv.filter(i=>["Growing","Rehab","Quarantine","Mother","Reserved"].includes(i.status)):dash==="sales"?inv.filter(i=>["Sellable","Staged for Live","Reserved","Sold"].includes(i.status)):dash==="fulfill"?inv.filter(i=>i.status==="Sold"):inv;if(!items.length){showToast("Nothing to export");return}const rows=items.map(i=>({SKU:i.sku,Name:i.name,Status:i.status,Qty:i.qty,Size:i.size||"",Zone:i.zone||"",Station:i.station||"",Notes:i.notes||""}));exportCSV(rows,`rpf_${dash}_${new Date().toISOString().slice(0,10)}.csv`);showToast(`Exported ${rows.length} rows`)};

  if(!auth)return<Login onLogin={handleLogin}/>;

  const labInv=inv.filter(i=>LAB_STATUSES.includes(i.status));
  const nurseInv=inv.filter(i=>!LAB_STATUSES.includes(i.status));
  const isLab=dash==="lab";
  const entity=isLab?"Lab":"Nursery";

  const nSt={growing:nurseInv.filter(i=>i.status==="Growing").reduce((a,b)=>a+b.qty,0),sellable:nurseInv.filter(i=>i.status==="Sellable").reduce((a,b)=>a+b.qty,0),staged:nurseInv.filter(i=>i.status==="Staged for Live").reduce((a,b)=>a+b.qty,0),mothers:nurseInv.filter(i=>i.status==="Mother").length,rehab:nurseInv.filter(i=>i.status==="Rehab").reduce((a,b)=>a+b.qty,0),quar:nurseInv.filter(i=>i.status==="Quarantine").reduce((a,b)=>a+b.qty,0),reserved:nurseInv.filter(i=>i.status==="Reserved").reduce((a,b)=>a+b.qty,0),total:nurseInv.reduce((a,b)=>a+b.qty,0)};
  const lSt={t1:labInv.filter(i=>i.status==="T1-Initiation").reduce((a,b)=>a+b.qty,0),t2:labInv.filter(i=>i.status==="T2-Multiplication").reduce((a,b)=>a+b.qty,0),t3:labInv.filter(i=>i.status==="T3-Rooting").reduce((a,b)=>a+b.qty,0),hard:labInv.filter(i=>i.status==="Hardening").reduce((a,b)=>a+b.qty,0),ready:labInv.filter(i=>i.status==="Transfer Ready").reduce((a,b)=>a+b.qty,0),contam:labInv.filter(i=>i.status==="Contaminated").reduce((a,b)=>a+b.qty,0),total:labInv.reduce((a,b)=>a+b.qty,0)};

  const nurseCols=[{k:"sku",l:"SKU",r:it=><span style={skS}>{it.sku}</span>},{k:"name",l:"Name",r:it=><span style={{fontWeight:600}}>{it.name}</span>},{k:"status",l:"Status",r:it=><Badge status={it.status}/>},{k:"qty",l:"Qty",r:it=><span style={{fontWeight:800}}>{it.qty}</span>},{k:"size",l:"Size",r:it=><span style={{color:W.t2}}>{it.size}</span>},{k:"zone",l:"Zone",r:it=><span style={{color:W.t3,fontSize:10}}>{it.zone}</span>}];
  const labCols=[{k:"sku",l:"SKU",r:it=><span style={skS}>{it.sku}</span>},{k:"name",l:"Name",r:it=><span style={{fontWeight:600}}>{it.name}</span>},{k:"status",l:"Stage",r:it=><Badge status={it.status}/>},{k:"qty",l:"Vessels",r:it=><span style={{fontWeight:800}}>{it.qty}</span>},{k:"zone",l:"Zone",r:it=><span style={{color:W.t3,fontSize:10}}>{it.zone}</span>},{k:"notes",l:"Notes",r:it=><span style={{color:W.t2,fontSize:10}}>{it.notes||"—"}</span>}];
  const fulfillCols=[{k:"sku",l:"SKU",r:it=><span style={skS}>{it.sku}</span>},{k:"name",l:"Name",r:it=><span style={{fontWeight:600}}>{it.name}</span>},{k:"qty",l:"Qty",r:it=><span style={{fontWeight:800}}>{it.qty}</span>},{k:"zone",l:"Zone"},{k:"station",l:"Station",r:it=>it.station||"—"},{k:"_",l:"Action",r:it=><button style={bP} onClick={e=>{e.stopPropagation();onStatusChange(it.id,it.sku,it.status,"Shipped")}}><Ic d={ico.chk} s={11}/> Ship</button>}];

  const navs=[{sec:"Nursery"},{k:"grow",l:"Grow Team",ic:ico.leaf,bg:nurseInv.filter(i=>["Growing","Rehab","Quarantine","Mother"].includes(i.status)).length},{k:"sales",l:"Sales",ic:ico.tag,bg:nurseInv.filter(i=>["Sellable","Staged for Live"].includes(i.status)).length},{k:"fulfill",l:"Fulfillment",ic:ico.box,bg:nurseInv.filter(i=>i.status==="Sold").length},{k:"live",l:"Live Sales",ic:ico.radio},{sec:"Lab"},{k:"lab",l:"TC Lab",ic:ico.flask,bg:labInv.length},{sec:"Operations"},{k:"all",l:"All Inventory",ic:ico.grid},{k:"log",l:"Activity Log",ic:ico.clock}];

  const dashLabel=(navs.find(n=>n.k===dash)||{}).l||"";
  const switchDash=d=>{setDash(d);setSel(null);setStF("");setZnF("")};
  const baseItems=dash==="grow"?nurseInv.filter(i=>["Growing","Rehab","Quarantine","Mother","Reserved"].includes(i.status)):dash==="sales"?nurseInv.filter(i=>["Sellable","Staged for Live","Reserved","Sold"].includes(i.status)):dash==="fulfill"?nurseInv.filter(i=>i.status==="Sold"):dash==="lab"?labInv:inv;

  const statCards=dash==="grow"?[["Growing",nSt.growing,STC.Growing,"in pipeline"],["Mothers",nSt.mothers,STC.Mother,"stock plants"],["Quarantine",nSt.quar,STC.Quarantine,"awaiting clear"],["Rehab",nSt.rehab,STC.Rehab,"recovering"],["Total",nSt.total,PK.pk,"nursery plants"]]:dash==="sales"?[["Sellable",nSt.sellable,STC.Sellable,"ready to list"],["Staged",nSt.staged,STC["Staged for Live"],"for live sale"],["Reserved",nSt.reserved,STC.Reserved,"holds"],["Pipeline",nSt.growing,STC.Quarantine,"growing → sellable"]]:dash==="fulfill"?[["To Ship",nurseInv.filter(i=>i.status==="Sold").reduce((a,b)=>a+b.qty,0),PK.pk,"awaiting pickup"],["Shipped",nurseInv.filter(i=>i.status==="Shipped").length,W.t3,"completed"]]:dash==="lab"?[["T1-Init",lSt.t1,"#2D6A4F","initiation"],["T2-Multi",lSt.t2,"#40916C","multiplication"],["T3-Root",lSt.t3,"#52B788","rooting"],["Hardening",lSt.hard,STC.Hardening,"acclimating"],["Transfer",lSt.ready,STC["Transfer Ready"],"ready for nursery"],["Contam",lSt.contam,STC.Contaminated,"flagged"],["Total",lSt.total,"#2D6A4F","all cultures"]]:[];

  return(<div style={{display:"flex",height:"100vh",fontFamily:"'DM Sans',system-ui,sans-serif",color:W.t,fontSize:13,background:W.bg}}>
    <Sidebar navs={navs} dash={dash} setDash={switchDash} email={auth.user?.email} onLogout={handleLogout}/>
    <div style={{flex:1,display:"flex",flexDirection:"column",overflow:"hidden"}}>
      <TopBar label={sel?sel.name:dashLabel} entity={entity} sq={sq} setSq={setSq} onRefresh={loadData} onNew={dash!=="live"&&dash!=="log"?()=>setModal(true):null} onScan={()=>setScanOpen(true)} onExport={dash!=="live"?doExportTab:null}/>
      <div style={{flex:1,overflowY:"auto",padding:20,background:W.bg}}>
        {loading&&inv.length===0?<div style={{display:"flex",alignItems:"center",justifyContent:"center",padding:40,color:W.t3}}>Loading…</div>:sel?<Detail item={sel} onBack={()=>setSel(null)} onStatusChange={onStatusChange}/>:<>
          {statCards.length>0&&<div style={{display:"grid",gridTemplateColumns:`repeat(${Math.min(statCards.length,7)},1fr)`,gap:10,marginBottom:18}}>{statCards.map(([label,val,color,sub],i)=>(<div key={i} onClick={()=>{if(dash==="grow"&&i<4)setStF(["Growing","Mother","Quarantine","Rehab"][i]);if(dash==="lab"&&i<6)setStF(["T1-Initiation","T2-Multiplication","T3-Rooting","Hardening","Transfer Ready","Contaminated"][i])}} style={{background:W.card,borderRadius:10,padding:"14px 16px",border:`1px solid ${W.b}`,cursor:"pointer",boxShadow:"0 1px 3px rgba(0,0,0,.04)"}}><div style={{fontSize:10,fontWeight:600,textTransform:"uppercase",letterSpacing:.8,color:W.t3}}>{label}</div><div style={{fontSize:28,fontWeight:800,letterSpacing:-1.5,marginTop:3,color}}>{val}</div><div style={{fontSize:10,color:W.t3,marginTop:1}}>{sub}</div></div>))}</div>}
          {dash==="live"?<LiveSalesDash inv={inv} showToast={showToast} loadData={loadData}/>:dash==="log"?<div style={{background:W.card,borderRadius:10,border:`1px solid ${W.b}`,overflow:"hidden",boxShadow:"0 1px 3px rgba(0,0,0,.04)"}}>{logData.length===0?<div style={{padding:30,textAlign:"center",color:W.t3}}>No activity yet.</div>:logData.map(a=><div key={a.id} style={{display:"flex",gap:10,padding:"11px 16px",borderBottom:`1px solid ${W.b}`,fontSize:12}}><div style={{width:6,height:6,borderRadius:"50%",marginTop:6,flexShrink:0,background:a.action==="status_change"?"#2563EB":a.action==="created"?STC.Growing:a.action==="staged_for_live"?STC["Staged for Live"]:W.t3}}/><div style={{flex:1}}><div><span style={{fontWeight:700}}>{a.action}</span> <span style={{...skS,fontSize:9}}>{a.sku}</span></div>{a.detail&&<div style={{color:W.t2,marginTop:1}}>{a.detail}</div>}</div><div style={{fontSize:10,color:W.t3,whiteSpace:"nowrap"}}>{new Date(a.created_at).toLocaleString()}</div></div>)}</div>:<FTable items={baseItems} cols={dash==="lab"?labCols:dash==="fulfill"?fulfillCols:nurseCols} onRow={setSel} stF={stF} setStF={setStF} znF={znF} setZnF={setZnF} sq={sq}/>}
        </>}
      </div>
    </div>
    {modal&&<SKUModal plants={plants} onClose={()=>setModal(false)} onAdd={onAdd} isLab={dash==="lab"}/>}
    {scanOpen&&<ScanModal onClose={()=>setScanOpen(false)} onResult={handleScanResult}/>}
    {toast&&<div style={{position:"fixed",bottom:20,left:"50%",transform:"translateX(-50%)",background:K.c,color:K.ct,padding:"8px 20px",borderRadius:8,fontSize:12,fontWeight:600,boxShadow:"0 4px 20px rgba(0,0,0,.3)",zIndex:200,border:`1px solid ${K.cb}`}}>{toast}</div>}
  </div>);
}
